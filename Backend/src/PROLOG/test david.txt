
:-op(220,xfx,entao).
:-op(35,xfy,se).
:-op(240,fx,regra).
:-op(500,fy,nao).
:-op(600,xfy,e).


regra 1 se [sintoma(_, 'Qual destes sintomas o automóvel apresenta?', ['1'], '1')] entao [].

regra 2 se [sintoma(_, 'Qual destes sintomas o automóvel apresenta?', ['1'], '1')
        e   sintoma(_, 'O automóvel tem consumido mais combustível do que o habitual?', ['Sim', 'Nao'], 'Sim')]
        entao [diagnostico(4, 'teste diagonostico 1', [])].

regra 3 se [sintoma(_, 'O automóvel tem consumido mais combustível do que o habitual?', ['Sim', 'Nao'], 'Sim') 
        e   sintoma(_, 'O automóvel tem uma perda de potência acentuada?', ['Sim', 'Nao'], 'Nao')]
        entao [diagnostico(_, 'teste diagonostico 2', [])].

regra 4 se [sintoma(_, 'Qual destes sintomas o automóvel apresenta?', ['fumo do escape', 'ruido'], ruido)] entao [diagnostico(_, 'teste diagonostico 2', [])].

regra 2 se [sintoma(_, 'Qual destes sintomas o automóvel apresenta?', ['1'], '1')
        e   sintoma(_, 'O automóvel tem consumido mais combustível do que o habitual?', ['Sim', 'Nao'], 'Sim')]
        entao [diagnostico(4, 'teste diagonostico 1', [])].

:- dynamic sintoma/4, diagnostico/3.

sintoma(_, 'Qual destes sintomas o automóvel apresenta?', ['1'], '1').

next_engine_handler(Request) :-
    http_read_json_dict(Request, DictList, []),
    %processar (DictList, EvidenciaAtomList, ValorAtomList),
    cria_sintomas(ID,EvidenciaAtom, ValorAtom),
    backup_regras(ID, LHS, RHS),
    sintomas_confirmados(SintomasConfirmados),
    aplica_regras(ID,LHS,RHS, SintomasConfirmados),
    %processa_regras.

processa_regras :-NovosSintomas
    findall((ID, LHS, RHS), (regra ID se LHS entao RHS), Regras),
    aplica_regras(Regras, []).

aplica_regras([(ID, LHS, RHS) | Regras], SintomasConfirmados) :-
    assert(backup_regras(ID, LHS, RHS)),
    assert(sintomas_confirmados(SintomasConfirmados)),
    condicao_compativel(LHS, SintomasConfirmados, ),
    concluir_diagnostico(ID, RHS, NovosSintomas),
    aplica_regras(Regras, NovosSintomas).

aplica_regras([], _).

condicao_compativel([A e B], SintomasConfirmados, NovosSintomas) :-
    verifica_sintoma(A),
    condicao_compativel([B], [A | SintomasConfirmados], NovosSintomas).

condicao_compativel([A], SintomasConfirmados, [A | SintomasConfirmados]) :-
    verifica_sintoma(A).

% Verifica se o sintoma existe e é compatível
verifica_sintoma(Sintoma) :-
    Sintoma = sintoma(ID, Evidencia, Opcoes, Valor),
    sintoma(_, Evidencia, Opcoes, Valor).

% Retorna falso se houver um valor diferente para a mesma evidência
verifica_sintoma(Sintoma) :-
    Sintoma = sintoma(ID, Evidencia, Opcoes, Valor),
    sintoma(_, Evidencia, Opcoes, ValorDiferente),
    Valor \= ValorDiferente,
    !.

% Caso a evidência ainda não tenha sido perguntada, pede ao utilizador
verifica_sintoma(Sintoma) :-
    Sintoma = sintoma(ID, Evidencia, Opcoes, Valor),
    % reply JSON
    !, fail.

cria_sintoma(Evidencia, Opcoes, Opcao) :-
    assertz(sintoma(_, Evidencia, Opcoes, Opcao)).

% Conclude and assert diagnostics based on rule conditions, with symptoms that led to it
concluir_diagnostico(_, [], _).

concluir_diagnostico(ID, [diagnostico()], SintomasConfirmados) :-
    assertz(diagnostico(ID, Diagnostico, SintomasConfirmados)),
    format('~w ', [Diagnostico]),
    retract(SintomasConfirmados).

cria_sintoma(Evidencia, Opcoes, Opcao) :-
    assertz(sintoma(_, Evidencia, Opcoes, Opcao)).

% Conclude and assert diagnostics based on rule conditions, with symptoms that led to it
concluir_diagnostico(_, [], _).

concluir_diagnostico(ID, [diagnostico()], SintomasConfirmados) :-
    assertz(diagnostico(ID, Diagnostico, SintomasConfirmados)),
    format('~w ', [Diagnostico]),
    retract(SintomasConfirmados).